---
description: Critical business rules and domain logic for the booking platform
---

# Business Rules & Domain Logic

## Credit System
- **1 credit = 50 cents** spending value (CREDITS_TO_CENTS_RATIO = 50)
- **Credit expiration**: VIP users get 5 months, regular users get 3 months
- **Double-entry ledger**: All credit transactions use bookkeeping
- **Payment safety**: Credits allocated only after payment confirmation

## Pricing & Discounts
- **Dynamic pricing**: Early bird (10%) takes precedence over capacity (5%) discounts
- **Base price chain**: instance.price → template.price → default(1000 cents)
- **Subscription tiers**: 5-tier discount structure (0%, 3%, 5%, 7%, 10%)
- **One-time packs**: 8 predefined packs (10, 25, 50, 100, 150, 200, 300, 500 credits)

## Booking System
- **Capacity management**: bookedCount cannot exceed capacity
- **Waitlist system**: Automatic promotion when cancellations occur
- **Cancellation windows**: Based on cancellationWindowHours before class start
- **Active booking limit**: Maximum 5 active bookings per consumer

## Timezone Handling
- **Business timezone priority**: All scheduling based on business local time
- **Greece timezone**: Default to Europe/Athens for consistency
- **UTC storage**: Database stores UTC timestamps, converts for display
- **No user timezone**: All users see business local time

## Revenue & Earnings
- **20% system cut**: Platform takes 20% of completed booking revenue
- **Completed bookings only**: Revenue calculations include only completed bookings
- **Cents storage**: All prices stored in cents for consistency
- **CSV export**: Businesses can export earnings data for invoicing

## Data Integrity
- **Historical snapshots**: Template/venue snapshots at instance creation
- **Audit trails**: All entities have createdAt, createdBy, updatedAt, updatedBy
- **Soft deletes**: Use deleted flags instead of hard deletes
- **Template propagation**: Changes update both instance fields and snapshots

## Validation Rules
- **Time constraints**: Start times ≤1 year future, durations ≤8 hours
- **Capacity limits**: Capacity ≤100 people, credits ≤100
- **String limits**: Names ≤100 chars, descriptions ≤2000 chars
- **Array limits**: Tags ≤10 items, selected days 0-6 range